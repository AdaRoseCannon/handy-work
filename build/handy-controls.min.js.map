{"version":3,"file":"handy-controls.min.js","sources":["../src/handy-controls.js"],"sourcesContent":["/* global AFRAME, THREE */\n\nconst __version__ = __version__;\nconst DEFAULT_HAND_PROFILE_PATH = \"https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/\";\nconst LIB_URL = \"https://cdn.jsdelivr.net/npm/handy-work@\" + __version__;\nconst LIB = LIB_URL + \"/build/esm/handy-work.standalone.js\";\nconst POSE_FOLDER = LIB_URL + \"/poses/\";\n\nconst joints = [\n  \"wrist\",\n  \"thumb-metacarpal\",\n  \"thumb-phalanx-proximal\",\n  \"thumb-phalanx-distal\",\n  \"thumb-tip\",\n  \"index-finger-metacarpal\",\n  \"index-finger-phalanx-proximal\",\n  \"index-finger-phalanx-intermediate\",\n  \"index-finger-phalanx-distal\",\n  \"index-finger-tip\",\n  \"middle-finger-metacarpal\",\n  \"middle-finger-phalanx-proximal\",\n  \"middle-finger-phalanx-intermediate\",\n  \"middle-finger-phalanx-distal\",\n  \"middle-finger-tip\",\n  \"ring-finger-metacarpal\",\n  \"ring-finger-phalanx-proximal\",\n  \"ring-finger-phalanx-intermediate\",\n  \"ring-finger-phalanx-distal\",\n  \"ring-finger-tip\",\n  \"pinky-finger-metacarpal\",\n  \"pinky-finger-phalanx-proximal\",\n  \"pinky-finger-phalanx-intermediate\",\n  \"pinky-finger-phalanx-distal\",\n  \"pinky-finger-tip\",\n];\n\nAFRAME.registerComponent(\"handy-controls\", {\n  schema: {\n    left: {\n      description: 'URL for left controller',\n      type: 'model',\n      default: DEFAULT_HAND_PROFILE_PATH + \"left.glb\",\n    },\n    right: {\n      description: 'URL for right controller',\n      type: 'model',\n      default: DEFAULT_HAND_PROFILE_PATH + \"right.glb\",\n    },\n    materialOverride: {\n      description: 'Which hand to use the `material` component for',\n      oneOf: ['both', 'left', 'right', 'none'],\n      default: 'both'\n    },\n    fuseVShort: {\n      description: 'Time for a pose to trigger a pose event (ms)',\n      default:48\n    },\n    fuseShort: {\n      description: 'Time for a pose to trigger a pose_fuseShort event (ms)',\n      default:480\n    },\n    fuseLong: {\n      description: 'Time for a pose to trigger a pose_fuseLong event (ms)',\n      default:1440\n    }\n  },\n  init() {\n    this.handyWorkCallback = this.handyWorkCallback.bind(this);\n    \n    const webxrData = this.el.sceneEl.getAttribute('webxr');\n    const optionalFeaturesArray = webxrData.optionalFeatures;\n    if (!optionalFeaturesArray.includes('hand-tracking')) {\n      optionalFeaturesArray.push('hand-tracking');\n      this.el.sceneEl.setAttribute('webxr', webxrData);\n    }\n    \n    const self = this;\n    const dracoLoader = this.el.sceneEl.systems['gltf-model'].getDRACOLoader();\n    const meshoptDecoder = this.el.sceneEl.systems['gltf-model'].getMeshoptDecoder();\n    this.model = null;\n    this.loader = new THREE.GLTFLoader();\n    if (dracoLoader) {\n      this.loader.setDRACOLoader(dracoLoader);\n    }\n    if (meshoptDecoder) {\n      this.ready = meshoptDecoder.then(function (meshoptDecoder) {\n        self.loader.setMeshoptDecoder(meshoptDecoder);\n      });\n    } else {\n      this.ready = Promise.resolve();\n    }\n    \n    import(LIB)\n    .then(function ({\n\t\t\tupdate,\n\t\t\tloadPose,\n\t\t\tdumpHands,\n      setPose,\n      getPose\n    }) {\n      this.handyWorkUpdate = update;\n      this.dumpHands = dumpHands;\n      this.loadPose = loadPose;\n      this.setPose = setPose;\n      this.getPose = getPose;\n\n      loadPose('relax', POSE_FOLDER + 'relax.handpose');\n      loadPose('fist', POSE_FOLDER + 'fist.handpose');\n      loadPose('flat', POSE_FOLDER + 'flat.handpose');\n      loadPose('point', POSE_FOLDER + 'point.handpose');\n      loadPose('horns', POSE_FOLDER + 'horns.handpose');\n      loadPose('shaka', POSE_FOLDER + 'shaka.handpose');\n      loadPose('vulcan', POSE_FOLDER + 'vulcan.handpose');\n    }.bind(this));\n    \n    for (const handedness of ['left', 'right']) {\n      const els = Array.from(this.el.querySelectorAll(`[data-${handedness}]`));\n      for (const el of els) {\n        el.object3D.visible = false;\n      }\n    }\n    \n    this.gripOffset = new THREE.Vector3(-0.005, -0.03, 0);\n    this.gripQuaternions = [new THREE.Quaternion().setFromUnitVectors(\n      new THREE.Vector3(0,0,-1),\n      new THREE.Vector3(-3,0,-1).normalize()\n    ),new THREE.Quaternion().setFromUnitVectors(\n      new THREE.Vector3(0,1,0),\n      new THREE.Vector3(-1,0,0)\n    )];\n    \n  },\n\n  async gltfToJoints(src, name) {\n    const el = this.el;\n    await this.ready;\n\n    const gltf = await new Promise(function (resolve, reject) {\n      this.loader.load(src, resolve, undefined, reject);\n    }.bind(this));\n\n    const object = gltf.scene.children[0];\n    const mesh = object.getObjectByProperty(\"type\", \"SkinnedMesh\");\n    \n    if (this.el.components.material) {\n      if (this.data.materialOverride === 'both' || this.data.materialOverride === name) {\n        mesh.material = this.el.components.material.material;\n      }\n    }\n    \n    mesh.visible = false;\n    mesh.frustumCulled = false;\n    mesh.castShadow = true;\n    mesh.receiveShadow = true;\n    mesh.skeleton.pose();\n    \n    const bones = [];\n    for (const jointName of joints) {\n      const bone = object.getObjectByName(jointName);\n      if (bone !== undefined) {\n        bone.jointName = jointName;\n        bones.push(bone);\n        bone.applyMatrix4(this.el.object3D.matrixWorld);\n        bone.updateMatrixWorld();\n      } else {\n        console.warn(`Couldn't find ${jointName} in ${src} hand mesh`);\n        bones.push(undefined); // add an empty slot\n      }\n    }\n    el.setObject3D('hand-mesh-' + name, mesh);\n    el.emit(\"model-loaded\", { format: \"gltf\", model: mesh });\n    return bones;\n  },\n\n  async update() {\n    const el = this.el;\n    const srcLeft = this.data.left;\n    const srcRight = this.data.right;\n\n    this.remove();\n    try {\n      this.bonesRight = await this.gltfToJoints(srcRight, \"right\");\n      this.bonesLeft = await this.gltfToJoints(srcLeft, \"left\");\n    } catch (error) {\n      const message = error && error.message ? error.message : \"Failed to load glTF model\";\n      console.warn(message);\n      el.emit(\"hand-model-error\", { message });\n    }\n  },\n  tick() {\n    const session = this.el.sceneEl.xrSession;\n    if (!session) return;\n    const referenceSpace = this.el.sceneEl.renderer.xr.getReferenceSpace();\n    \n    const toUpdate = [];\n    const frame = this.el.sceneEl.frame;\n    for (const inputSource of session.inputSources) {\n      \n      const currentMesh = this.el.getObject3D(\"hand-mesh-\" + inputSource.handedness);\n      if (!currentMesh) return;\n      \n      const els = Array.from(this.el.querySelectorAll(`[data-${inputSource.handedness}]`));\n      const elMap = new Map();\n      for (const el of els) {\n        const poseName = el.dataset[inputSource.handedness];\n        const elArray = elMap.get(poseName) || [];\n        elArray.push(el);\n        elMap.set(poseName, elArray);\n      }\n\n      if (!inputSource.hand) {\n        for (const el of els) {\n          el.object3D.visible = false;\n        }\n        currentMesh.visible = false;\n        continue;\n      }\n      toUpdate.push(inputSource);\n\n      const bones =\n        (inputSource.handedness === \"right\" && this.bonesRight) ||\n        (inputSource.handedness === \"left\" && this.bonesLeft);\n      if (!bones) continue;\n      for (const bone of bones) {\n        const joint = inputSource.hand.get(bone.jointName);\n        if (joint) {\n          const pose = frame.getJointPose(joint, referenceSpace);\n          if (pose) {\n            currentMesh.visible = true;\n            if (elMap.has(bone.jointName)) {\n              for (const el of elMap.get(bone.jointName)) {\n                el.object3D.position.copy(pose.transform.position);\n                el.object3D.quaternion.copy(pose.transform.orientation);\n                el.object3D.visible = (el.getDOMAttribute('visible') !== false);\n              }\n            }\n            \n            if (bone.jointName === \"middle-finger-metacarpal\") {\n              if (elMap.has('grip')) {\n                for (const el of elMap.get('grip')) {\n                  el.object3D.quaternion.copy(pose.transform.orientation);\n                  this.gripQuaternions.forEach(q => el.object3D.quaternion.multiply(q));\n                  el.object3D.position.copy(this.gripOffset);\n                  el.object3D.position.applyQuaternion(el.object3D.quaternion);\n                  el.object3D.position.add(pose.transform.position);\n                  el.object3D.visible = (el.getDOMAttribute('visible') !== false);\n                }\n              }\n            }\n            \n            bone.position.copy(pose.transform.position);\n            bone.quaternion.copy(pose.transform.orientation);\n            bone.applyMatrix4(this.el.object3D.matrixWorld);\n            bone.updateMatrixWorld();\n          }\n        }\n      }\n      // Ideally we would do this but the grip space doesn't actually line up with where you hold something so I map it to the middle finger metacarpal isntead\n      // if (elMap.has('grip') && inputSource.gripSpace) {\n      //   const pose = frame.getPose(inputSource.gripSpace, referenceSpace);\n      //   if (pose) {\n      //     for (const el of elMap.get('grip')) {\n      //       el.object3D.position.copy(pose.transform.position);\n      //       el.object3D.quaternion.copy(pose.transform.orientation);\n      //       el.object3D.visible = (el.getDOMAttribute('visible') !== false);\n      //     }\n      //   }\n      // }\n      if (elMap.has('ray') && inputSource.targetRaySpace) {\n        const pose = frame.getPose(inputSource.targetRaySpace, referenceSpace);\n        if (pose) {\n          for (const el of elMap.get('ray')) {\n            el.object3D.position.copy(pose.transform.position);\n            el.object3D.quaternion.copy(pose.transform.orientation);\n            el.object3D.visible = (el.getDOMAttribute('visible') !== false);\n          }\n        }\n      }\n    }\n\n    // perform hand tracking\n    if (toUpdate.length && this.handyWorkUpdate) {\n      this.handyWorkUpdate(\n        toUpdate,\n        referenceSpace,\n        frame,\n        this.handyWorkCallback\n      );\n    }\n  },\n  handyWorkCallback: function ({\n\t\tdistances, handedness\n\t}) {\n\t\tthis.emit(distances[0][0], handedness, {\n      pose: distances[0][0],\n      poses: distances,\n      handedness\n    });\n\t},\n  emit(name, handedness, details) {\n    if (name === this[handedness + '_currentPose']) return;\n    \n    // console.log(`Old pose was ${this[handedness + '_currentPose']} current pose is ${name}, so resetting events`);\n    \n    const els = Array.from(this.el.querySelectorAll(`[data-${handedness}]`));\n    \n    clearTimeout(this[handedness + '_vshortTimeout']);\n    clearTimeout(this[handedness + '_shortTimeout']);\n    clearTimeout(this[handedness + '_longTimeout']);\n    \n    this[handedness + '_currentPose'] = name;\n\n    this[handedness + '_vshortTimeout'] = setTimeout(() => {\n      this.el.emit('pose_' + name, details);\n      this.el.emit('pose', details);\n\n      for (const el of els) {\n        el.emit('pose_' + name, details, false);\n        el.emit('pose', details, false);\n      }\n    }, this.data.fuseVShort);\n    \n    this[handedness + '_shortTimeout'] = setTimeout(() => {\n      // console.log('Emiting ', name + '_fuseShort');\n      this.el.emit('pose_' + name + '_fuseShort', details);\n      for (const el of els) el.emit('pose_' + name + '_fuseShort', details, false);\n    }, this.data.fuseShort);\n    \n    this[handedness + '_longTimeout'] = setTimeout(() => {\n      // console.log('Emiting ', name + '_fuseLong');\n      this.el.emit('pose_' + name + '_fuseLong', details);    \n      for (const el of els) el.emit('pose_' + name + '_fuseLong', details, false);\n    }, this.data.fuseLong);\n  },\n  remove() {\n    if (this.bonesLeft) {\n      this.bonesLeft = null;\n      this.el.removeObject3D(\"hand-mesh-left\");\n    }\n    if (this.bonesRight) {\n      this.bonesRight = null;\n      this.el.removeObject3D(\"hand-mesh-right\")\n    }\n  },\n});\n"],"names":["DEFAULT_HAND_PROFILE_PATH","LIB_URL","POSE_FOLDER","joints","AFRAME","registerComponent","schema","left","description","type","default","right","materialOverride","oneOf","fuseVShort","fuseShort","fuseLong","init","this","handyWorkCallback","bind","webxrData","el","sceneEl","getAttribute","optionalFeaturesArray","optionalFeatures","includes","push","setAttribute","self","dracoLoader","systems","getDRACOLoader","meshoptDecoder","getMeshoptDecoder","model","loader","THREE","GLTFLoader","setDRACOLoader","ready","then","setMeshoptDecoder","Promise","resolve","import","update","loadPose","dumpHands","setPose","getPose","handyWorkUpdate","handedness","els","Array","from","querySelectorAll","object3D","visible","gripOffset","Vector3","gripQuaternions","Quaternion","setFromUnitVectors","normalize","async","src","name","object","reject","load","undefined","scene","children","mesh","getObjectByProperty","components","material","data","frustumCulled","castShadow","receiveShadow","skeleton","pose","bones","jointName","bone","getObjectByName","applyMatrix4","matrixWorld","updateMatrixWorld","console","warn","setObject3D","emit","format","srcLeft","srcRight","remove","bonesRight","gltfToJoints","bonesLeft","error","message","tick","session","xrSession","referenceSpace","renderer","xr","getReferenceSpace","toUpdate","frame","inputSource","inputSources","currentMesh","getObject3D","elMap","Map","poseName","dataset","elArray","get","set","hand","joint","getJointPose","has","position","copy","transform","quaternion","orientation","getDOMAttribute","forEach","q","multiply","applyQuaternion","add","targetRaySpace","length","distances","poses","details","clearTimeout","setTimeout","removeObject3D"],"mappings":"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"}