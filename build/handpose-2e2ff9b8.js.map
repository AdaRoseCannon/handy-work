{"version":3,"file":"handpose-2e2ff9b8.js","sources":["../src/handpose.js","../src/handpose.js?comlink"],"sourcesContent":["// this runs as a web worker\nimport {transfer} from 'comlink';\nimport normalize from './normalize.js';\nimport { Matrix4, Quaternion, Vector3 } from 'three';\n\nconsole.log('Worker started');\n\nconst poses = new Map();\nconst tempMat1 = new Matrix4();\nconst tempMat2 = new Matrix4();\nconst tempQuat1 = new Quaternion();\nconst tempQuat2 = new Quaternion();\nconst tempVec1 = new Vector3();\nconst tempVec2 = new Vector3();\n\n\nclass HandPose {\n\t#matches\n\tconstructor () {\n\t\tthis.#matches = [];\n\t}\n\tstatic async loadPose(name, path) {\n\t\tconst url = new URL(path, import.meta.url);\n\t\tconst buffer = await fetch(url).then(response => response.arrayBuffer());\n\t\tconst pose = new Float32Array(buffer);\n\t\tposes.set(name, pose);\n\t}\n\tupdate (headPose, handPose, handedness) {\n\n\t\tnormalize(handPose);\n\n\t\tconst distances = [];\n\t\tfor (const [name, poseData] of poses) {\n\t\t\tconst isRight = Number(handedness === \"right\");\n\t\t\tconst poseHandDataSize = poseData[0];\n\t\t\tconst poseHandData = new Float32Array(poseData.buffer, (\n\t\t\t\t1 + // poseHandDataSize offset\n\t\t\t\t(poseHandDataSize * 16) * isRight // offset for right hand\n\t\t\t)*4 , poseHandDataSize * 16);\n\t\t\tconst poseWeightData = new Float32Array(poseData.buffer, (\n\t\t\t\t1 + // poseHandDataSize offset\n\t\t\t\t(poseHandDataSize * 16) * 2 + // offset for after hand data\n\t\t\t\t(poseHandDataSize * isRight)      // offset for right hand\n\t\t\t)*4 , poseHandDataSize);\n\n\t\t\tconst jointCount = Math.min(poseHandDataSize, handPose.length/16);\n\t\t\tlet dist = 0;\n\t\t\tfor (let i=0; i<jointCount; i++) {\n\n\t\t\t\t// Algo based on join rotation apply quaternion to a vector and\n\t\t\t\t// compare positions of vectors should work a bit better\n\t\t\t\tconst o = i*16;\n\t\t\t\ttempMat1.fromArray(poseHandData, o);\n\t\t\t\ttempMat2.fromArray(handPose, o);\n\t\t\t\ttempQuat1.setFromRotationMatrix(tempMat1);\n\t\t\t\ttempQuat2.setFromRotationMatrix(tempMat2);\n\t\t\t\ttempVec1.set(0,0,0.1).applyQuaternion(tempQuat1);\n\t\t\t\ttempVec2.set(0,0,0.1).applyQuaternion(tempQuat2);\n\t\t\t\tdist += tempVec1.distanceTo(tempVec2);\n\n\t\t\t\t// Alternative simpler & faster algo based on joint position\n\t\t\t\t// const o = i*16;\n\t\t\t\t// dist += Math.pow(\n\t\t\t\t// \t(poseHandData[o + 12] - handPose[o + 12]) ** 2 +\n\t\t\t\t// \t(poseHandData[o + 13] - handPose[o + 13]) ** 2 +\n\t\t\t\t// \t(poseHandData[o + 14] - handPose[o + 14]) ** 2\n\t\t\t\t// , 0.5);\n\t\t\t}\n\t\t\tdistances.push([name, dist]);\n\t\t}\n\n\t\treturn transfer({\n\t\t\tusedHandArrayBuffer: handPose,\n\t\t\tdistances: distances.sort((a,b)=>a[1]-b[1])\n\t\t}, [handPose.buffer]);\n\t}\n\tgetMatchedPoses () {\n\t\treturn this.#matches;\n\t}\n}\n\nexport default HandPose;\n","\n\t\timport * as m from \"/home/ada/gitWorkingDir/handy-work/src/handpose.js\";\n\t\timport {expose} from \"comlink\";\n\n\t\texpose(m);\n\t"],"names":["console","log","poses","Map","tempMat1","Matrix4","tempMat2","tempQuat1","Quaternion","tempQuat2","tempVec1","Vector3","tempVec2","expose","[object Object]","this","name","path","url","URL","import","meta","buffer","fetch","then","response","arrayBuffer","pose","Float32Array","set","headPose","handPose","handedness","normalize","distances","poseData","isRight","Number","poseHandDataSize","poseHandData","jointCount","Math","min","length","dist","i","o","fromArray","setFromRotationMatrix","applyQuaternion","distanceTo","push","transfer","usedHandArrayBuffer","sort","a","b"],"mappings":"4EAKAA,QAAQC,IAAI,kBAEZ,MAAMC,EAAQ,IAAIC,IACZC,EAAW,IAAIC,EACfC,EAAW,IAAID,EACfE,EAAY,IAAIC,EAChBC,EAAY,IAAID,EAChBE,EAAW,IAAIC,EACfC,EAAW,IAAID,ECTnBE,wCDYF,MACCC,SACAA,cACCC,cAAgB,GAEjBD,sBAAsBE,EAAMC,GAC3B,MAAMC,EAAM,IAAIC,IAAIF,EAAMG,OAAOC,KAAKH,KAChCI,QAAeC,MAAML,GAAKM,MAAKC,GAAYA,EAASC,gBACpDC,EAAO,IAAIC,aAAaN,GAC9BpB,EAAM2B,IAAIb,EAAMW,GAEjBb,OAAQgB,EAAUC,EAAUC,GAE3BC,EAAUF,GAEV,MAAMG,EAAY,GAClB,IAAK,MAAOlB,EAAMmB,KAAajC,EAAO,CACrC,MAAMkC,EAAUC,OAAsB,UAAfL,GACjBM,EAAmBH,EAAS,GAC5BI,EAAe,IAAIX,aAAaO,EAASb,OAG7C,GAFD,EACoB,GAAnBgB,EAAyBF,GACF,GAAnBE,GACiB,IAAIV,aAAaO,EAASb,OAI/C,GAHD,EACoB,GAAnBgB,EAAyB,EACzBA,EAAmBF,GACfE,GAEN,MAAME,EAAaC,KAAKC,IAAIJ,EAAkBP,EAASY,OAAO,IAC9D,IAAIC,EAAO,EACX,IAAK,IAAIC,EAAE,EAAGA,EAAEL,EAAYK,IAAK,CAIhC,MAAMC,EAAM,GAAFD,EACVzC,EAAS2C,UAAUR,EAAcO,GACjCxC,EAASyC,UAAUhB,EAAUe,GAC7BvC,EAAUyC,sBAAsB5C,GAChCK,EAAUuC,sBAAsB1C,GAChCI,EAASmB,IAAI,EAAE,EAAE,IAAKoB,gBAAgB1C,GACtCK,EAASiB,IAAI,EAAE,EAAE,IAAKoB,gBAAgBxC,GACtCmC,GAAQlC,EAASwC,WAAWtC,GAU7BsB,EAAUiB,KAAK,CAACnC,EAAM4B,IAGvB,OAAOQ,EAAS,CACfC,oBAAqBtB,EACrBG,UAAWA,EAAUoB,MAAK,CAACC,EAAEC,IAAID,EAAE,GAAGC,EAAE,MACtC,CAACzB,EAAST,SAEdR,kBACC,OAAOC"}